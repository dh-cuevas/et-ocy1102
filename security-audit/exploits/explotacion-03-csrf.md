# Explotación 3: Cross-Site Request Forgery (CSRF)

**Auditor:** DAVID H. CUEVAS SALGADO  
**Fecha:** 29/11/2025 18:12  
**Vulnerabilidad:** CSRF  
**Severidad:** MEDIA (CVSS 6.5)

---

## Descripción del Exploit

Se logró forzar a un usuario autenticado a realizar acciones no autorizadas (publicar comentarios) mediante un sitio web malicioso que envía peticiones POST a la aplicación vulnerable aprovechando la sesión activa del usuario.

## Vector de Ataque

1. Atacante crea página maliciosa (csrf_attack.html)
2. Víctima tiene sesión activa en la app vulnerable
3. Víctima visita página maliciosa (ingeniería social)
4. Página envía petición POST automática o mediante clic
5. Comentario malicioso publicado sin consentimiento

## Código Malicioso

\\\html
<form action="http://localhost:5000/submit_comment" method="POST">
    <input type="hidden" name="comment" value="MENSAJE MALICIOSO">
    <button type="submit">¡Reclamar Premio!</button>
</form>
\\\

## Pasos de Explotación

1. Usuario autenticado en http://localhost:5000
2. Usuario visita sitio del atacante
3. Click en botón aparentemente legítimo
4. Formulario envía POST a /submit_comment
5. Backend acepta petición (sesión válida, sin token CSRF)
6. Comentario malicioso almacenado

## Evidencia

- Página maliciosa: \security-audit/exploits/csrf_attack.html\
- Comentario inyectado sin consentimiento
- No hay validación de token CSRF
- No hay validación de origen (Referer/Origin)

## Impacto Demostrado

- **Publicación de contenido malicioso**
- **Cambio de configuración de cuenta**
- **Acciones administrativas** (si víctima es admin)
- **Propagación de XSS** (comentario + XSS payload)

## Código Vulnerable

\\\python
@app.route('/submit_comment', methods=['POST'])
def submit_comment():
    # Sin validación de token CSRF
    comment = request.form['comment']
    conn.execute("INSERT INTO comments (...) VALUES (...)", (user_id, comment))
\\\

## Variantes de Ataque

- Auto-submit con JavaScript
- Petición AJAX cross-origin
- Imagen invisible que dispara POST
- Iframe oculto

## Recomendaciones

1. Implementar Flask-WTF con tokens CSRF
2. Validar header Origin/Referer
3. Configurar SameSite=Strict en cookies
4. Double-submit cookie pattern

---

**Status:** EXPLOTACIÓN EXITOSA

