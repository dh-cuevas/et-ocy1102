# Explotación 4: Gestión Insegura de Sesiones

**Auditor:** David H. Cuevas Salgado  
**Fecha:** 29/11/2025 19:06  
**Vulnerabilidad:** Session Management  
**Severidad:** MEDIA (CVSS 5.3)

---

## Descripción del Exploit

La aplicación genera una secret_key aleatoria en cada inicio usando \os.urandom(24)\. Esto causa que todas las sesiones activas se invaliden cada vez que se reinicia el servidor.

## Código Vulnerable

\\\python
# En vulnerable_flask_app.py línea 11
app.secret_key = os.urandom(24)
\\\

## Prueba de Concepto

### Test 1: Invalidación al reiniciar

1. Usuario hace login → Cookie de sesión válida
2. Servidor se reinicia → Nueva secret_key generada
3. Cookie anterior ya no puede descifrarse
4. Usuario es deslogueado automáticamente

### Test 2: Análisis de persistencia

\\\ash
# Terminal 1: Hacer login
curl -c cookies.txt -d "username=admin&password=password" http://localhost:5000/login

# Terminal 2: Reiniciar servidor
docker-compose restart

# Terminal 1: Intentar usar sesión anterior
curl -b cookies.txt http://localhost:5000/dashboard
# Resultado: Redirect a /login
\\\

## Evidencia

- ✅ Script: \security-audit/exploits/04_session_management.py\
- ✅ Sesiones invalidadas tras reinicio confirmado
- ✅ Secret key no persistente verificado
- ✅ Múltiples sesiones analizadas

## Impacto Demostrado

### Disponibilidad
- Logout masivo de usuarios al reiniciar
- Pérdida de carritos de compra
- Interrupción de sesiones activas

### Experiencia de Usuario
- Frustración por deslogueo inesperado
- Pérdida de trabajo no guardado
- Necesidad de re-autenticación frecuente

### Seguridad
- Dificultad para auditar sesiones
- Imposibilidad de revocar sesiones específicas
- No hay control sobre tiempo de vida

## Problemas Adicionales

1. **Longitud insuficiente:** 24 bytes puede no ser suficiente
2. **No hay rotación controlada:** La key cambia sin planificación
3. **Sin variables de entorno:** Hardcoded en código
4. **Sin timeout de sesión:** Sesiones viven indefinidamente (hasta reinicio)

## Recomendaciones

### Solución 1: Secret key persistente
\\\python
import os
app.secret_key = os.environ.get('SECRET_KEY') or 'dev-secret-key-change-in-production'
\\\

### Solución 2: Generación segura una sola vez
\\\python
# secrets.token_hex() es más seguro
import secrets
app.secret_key = secrets.token_hex(32)
# Guardar en .env o secrets manager
\\\

### Solución 3: Configuración de sesión
\\\python
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(hours=1)
app.config['SESSION_COOKIE_SECURE'] = True
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
\\\

---

**Status:** ✅ EXPLOTACIÓN EXITOSA

